<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email RAG System - Test Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .nav-tab.active {
            background: white;
            border-bottom-color: #667eea;
            color: #667eea;
        }

        .tab-content {
            padding: 30px;
            min-height: 600px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 120px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .result-container {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .result-container h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .result-content {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e1e5e9;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .sample-emails {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .sample-email {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            border: 1px solid #e1e5e9;
        }

        .sample-email h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .sample-email p {
            margin-bottom: 5px;
            font-size: 14px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success {
            background: #28a745;
        }

        .status-error {
            background: #dc3545;
        }

        .status-loading {
            background: #ffc107;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .stats-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
            text-align: center;
        }

        .stats-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stats-label {
            color: #6c757d;
            font-size: 14px;
        }

        .email-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .email-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            border: 1px solid #e1e5e9;
        }

        .email-subject {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .email-meta {
            font-size: 12px;
            color: #6c757d;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
        }

        .success {
            color: #155724;
            background: #d4edda;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                margin: 10px;
            }
            
            .tab-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìß Email RAG System</h1>
            <p>Test Interface for Email Ingestion and AI-Powered Querying</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('ingest')">üì• Ingest Emails</button>
            <button class="nav-tab" onclick="showTab('query')">üîç Query Emails</button>
            <button class="nav-tab" onclick="showTab('list')">üìã List Emails</button>
            <button class="nav-tab" onclick="showTab('stats')">üìä Statistics</button>
            <button class="nav-tab" onclick="showTab('search')">üîé Advanced Search</button>
            <button class="nav-tab" onclick="showTab('manage')">‚öôÔ∏è Manage</button>
        </div>

        <div class="tab-content">
            <!-- Ingest Tab -->
            <div id="ingest" class="tab-pane active">
                <h2>üì• Ingest Emails</h2>
                <p>Upload email data in JSON format to the vector database.</p>

                <div class="sample-emails">
                    <h3>Sample Email Data</h3>
                    <div class="sample-email">
                        <h4>Project Update Email</h4>
                        <p><strong>From:</strong> john.doe@company.com</p>
                        <p><strong>Subject:</strong> Project Update - Q1 Goals</p>
                        <p><strong>Has Attachments:</strong> Yes</p>
                    </div>
                    <div class="sample-email">
                        <h4>Invoice Email</h4>
                        <p><strong>From:</strong> sarah.wilson@vendor.com</p>
                        <p><strong>Subject:</strong> Invoice #INV-2024-001 - Software Licenses</p>
                        <p><strong>Has Attachments:</strong> Yes</p>
                    </div>
                    <div class="sample-email">
                        <h4>HR Policy Email</h4>
                        <p><strong>From:</strong> hr@company.com</p>
                        <p><strong>Subject:</strong> New Employee Handbook and Policy Updates</p>
                        <p><strong>Has Attachments:</strong> Yes</p>
                    </div>
                </div>

                <div class="form-group">
                    <label for="emailData">Email Data (JSON Array)</label>
                    <textarea id="emailData" class="form-control" rows="15" placeholder="Paste your email JSON data here..."></textarea>
                </div>

                <button class="btn" onclick="loadSampleData()">üìù Load Sample Data</button>
                <button class="btn btn-success" onclick="ingestEmails()">üì• Ingest Emails</button>
                <button class="btn btn-secondary" onclick="clearEmailData()">üóëÔ∏è Clear</button>

                <div id="ingestResult" class="result-container" style="display: none;">
                    <h3>Ingestion Result</h3>
                    <div id="ingestContent" class="result-content"></div>
                </div>
            </div>

            <!-- Query Tab -->
            <div id="query" class="tab-pane">
                <h2>üîç Query Emails</h2>
                <p>Ask natural language questions about your emails using AI.</p>

                <div class="form-group">
                    <label for="queryText">Your Question</label>
                    <input type="text" id="queryText" class="form-control" placeholder="e.g., What project updates were shared?">
                </div>

                <div class="grid">
                    <div class="form-group">
                        <label for="topK">Number of Results</label>
                        <input type="number" id="topK" class="form-control" value="5" min="1" max="50">
                    </div>
                    <div class="form-group">
                        <label for="temperature">AI Temperature</label>
                        <input type="number" id="temperature" class="form-control" value="0.3" min="0" max="1" step="0.1">
                    </div>
                </div>

                <div class="form-group">
                    <label for="senderFilter">Filter by Sender (optional)</label>
                    <input type="email" id="senderFilter" class="form-control" placeholder="sender@domain.com">
                </div>

                <button class="btn" onclick="queryEmails()">üîç Ask Question</button>
                <button class="btn btn-secondary" onclick="loadSampleQueries()">üìù Load Sample Questions</button>

                <div id="queryResult" class="result-container" style="display: none;">
                    <h3>AI Response</h3>
                    <div id="queryContent" class="result-content"></div>
                </div>
            </div>

            <!-- List Tab -->
            <div id="list" class="tab-pane">
                <h2>üìã Email List</h2>
                <p>Browse all emails with filtering and pagination.</p>

                <div class="grid">
                    <div class="form-group">
                        <label for="listSender">Filter by Sender</label>
                        <input type="email" id="listSender" class="form-control" placeholder="sender@domain.com">
                    </div>
                    <div class="form-group">
                        <label for="listDomain">Filter by Domain</label>
                        <input type="text" id="listDomain" class="form-control" placeholder="company.com">
                    </div>
                </div>

                <div class="grid">
                    <div class="form-group">
                        <label for="listLimit">Results per Page</label>
                        <input type="number" id="listLimit" class="form-control" value="20" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label for="hasAttachments">Has Attachments</label>
                        <select id="hasAttachments" class="form-control">
                            <option value="">All emails</option>
                            <option value="true">With attachments</option>
                            <option value="false">Without attachments</option>
                        </select>
                    </div>
                </div>

                <button class="btn" onclick="listEmails()">üìã List Emails</button>
                <button class="btn btn-secondary" onclick="clearFilters()">üóëÔ∏è Clear Filters</button>

                <div id="listResult" class="result-container" style="display: none;">
                    <h3>Email List</h3>
                    <div id="listContent" class="email-list"></div>
                </div>
            </div>

            <!-- Stats Tab -->
            <div id="stats" class="tab-pane">
                <h2>üìä Email Statistics</h2>
                <p>View statistics about your email collection.</p>

                <button class="btn" onclick="getStats()">üìä Get Statistics</button>
                <button class="btn btn-success" onclick="checkHealth()">üè• Health Check</button>

                <div id="statsResult" style="display: none; margin-top: 20px;">
                    <div class="grid">
                        <div class="stats-card">
                            <div class="stats-number" id="totalEmails">-</div>
                            <div class="stats-label">Total Emails</div>
                        </div>
                        <div class="stats-card">
                            <div class="stats-number" id="uniqueSenders">-</div>
                            <div class="stats-label">Unique Senders</div>
                        </div>
                        <div class="stats-card">
                            <div class="stats-number" id="uniqueDomains">-</div>
                            <div class="stats-label">Unique Domains</div>
                        </div>
                        <div class="stats-card">
                            <div class="stats-number" id="totalAttachments">-</div>
                            <div class="stats-label">Total Attachments</div>
                        </div>
                    </div>
                </div>

                <div id="healthResult" class="result-container" style="display: none;">
                    <h3>System Health</h3>
                    <div id="healthContent" class="result-content"></div>
                </div>
            </div>

            <!-- Advanced Search Tab -->
            <div id="search" class="tab-pane">
                <h2>üîé Advanced Email Search</h2>
                <p>Search emails with multiple criteria and filters.</p>

                <div class="form-group">
                    <label for="searchQuery">Search Query</label>
                    <input type="text" id="searchQuery" class="form-control" placeholder="e.g., software licenses">
                </div>

                <div class="grid">
                    <div class="form-group">
                        <label for="searchSender">Sender Email</label>
                        <input type="email" id="searchSender" class="form-control" placeholder="sender@domain.com">
                    </div>
                    <div class="form-group">
                        <label for="searchDomain">Sender Domain</label>
                        <input type="text" id="searchDomain" class="form-control" placeholder="company.com">
                    </div>
                </div>

                <div class="grid">
                    <div class="form-group">
                        <label for="dateFrom">Date From</label>
                        <input type="datetime-local" id="dateFrom" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="dateTo">Date To</label>
                        <input type="datetime-local" id="dateTo" class="form-control">
                    </div>
                </div>

                <div class="grid">
                    <div class="form-group">
                        <label for="subjectContains">Subject Contains</label>
                        <input type="text" id="subjectContains" class="form-control" placeholder="invoice">
                    </div>
                    <div class="form-group">
                        <label for="searchAttachments">Has Attachments</label>
                        <select id="searchAttachments" class="form-control">
                            <option value="">Any</option>
                            <option value="true">With attachments</option>
                            <option value="false">Without attachments</option>
                        </select>
                    </div>
                </div>

                <button class="btn" onclick="advancedSearch()">üîé Advanced Search</button>
                <button class="btn btn-secondary" onclick="clearSearchForm()">üóëÔ∏è Clear</button>

                <div id="searchResult" class="result-container" style="display: none;">
                    <h3>Search Results</h3>
                    <div id="searchContent" class="email-list"></div>
                </div>
            </div>

            <!-- Manage Tab -->
            <div id="manage" class="tab-pane">
                <h2>‚öôÔ∏è Manage Emails</h2>
                <p>Delete emails and manage your email collection.</p>

                <div class="form-group">
                    <label for="deleteEmailId">Delete Specific Email by ID</label>
                    <input type="text" id="deleteEmailId" class="form-control" placeholder="email_001">
                </div>
                <button class="btn btn-danger" onclick="deleteEmail()">üóëÔ∏è Delete Email</button>

                <hr style="margin: 30px 0;">

                <h3>Batch Delete</h3>
                <div class="grid">
                    <div class="form-group">
                        <label for="batchDeleteSender">Delete by Sender</label>
                        <input type="email" id="batchDeleteSender" class="form-control" placeholder="sender@domain.com">
                    </div>
                    <div class="form-group">
                        <label for="batchDeleteDomain">Delete by Domain</label>
                        <input type="text" id="batchDeleteDomain" class="form-control" placeholder="spam.com">
                    </div>
                </div>
                <button class="btn btn-danger" onclick="batchDeleteEmails()">üóëÔ∏è Batch Delete</button>

                <hr style="margin: 30px 0;">

                <h3 style="color: #dc3545;">‚ö†Ô∏è Danger Zone</h3>
                <p style="color: #6c757d;">These actions cannot be undone!</p>
                <div class="form-group">
                    <label for="confirmClear">Type "DELETE_ALL_EMAILS" to confirm</label>
                    <input type="text" id="confirmClear" class="form-control" placeholder="DELETE_ALL_EMAILS">
                </div>
                <button class="btn btn-danger" onclick="clearAllEmails()">üßπ Clear All Emails</button>

                <div id="manageResult" class="result-container" style="display: none;">
                    <h3>Management Result</h3>
                    <div id="manageContent" class="result-content"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/emails';
        
        // Sample email data
        const sampleEmailsData = [
            {
                email_id: "email_001",
                sender_email: "john.doe@company.com",
                receiver_emails: ["jane.smith@company.com", "team@company.com"],
                cc_emails: ["manager@company.com"],
                bcc_emails: [],
                time_received: "2024-01-15T10:30:00Z",
                subject: "Project Update - Q1 Goals",
                body: "Hi team, I wanted to share an update on our Q1 project goals. We've made significant progress on the new feature development and are on track to meet our deadlines. The user feedback has been overwhelmingly positive, with a 95% satisfaction rate. Next steps include finalizing the documentation and preparing for the beta release.",
                attachments: [
                    {
                        name: "project_timeline.pdf",
                        type: "application/pdf",
                        size: "2.5MB"
                    }
                ]
            },
            {
                email_id: "email_002",
                sender_email: "sarah.wilson@vendor.com",
                receiver_emails: ["procurement@company.com"],
                cc_emails: [],
                bcc_emails: [],
                time_received: "2024-01-16T14:45:00Z",
                subject: "Invoice #INV-2024-001 - Software Licenses",
                body: "Please find attached the invoice for the annual software licenses renewal. The total amount is $12,500 and payment is due within 30 days. This covers licenses for our project management tools, development environments, and security software for 50 users.",
                attachments: [
                    {
                        name: "invoice_INV-2024-001.pdf",
                        type: "application/pdf",
                        size: "1.2MB"
                    }
                ]
            },
            {
                email_id: "email_003",
                sender_email: "hr@company.com",
                receiver_emails: ["all@company.com"],
                cc_emails: [],
                bcc_emails: [],
                time_received: "2024-01-17T09:00:00Z",
                subject: "New Employee Handbook and Policy Updates",
                body: "Dear team, we've updated our employee handbook with new policies regarding remote work, vacation time, and professional development opportunities. Key changes include increased remote work flexibility, additional mental health days, and a new professional development budget of $2,000 per employee annually.",
                attachments: [
                    {
                        name: "employee_handbook_2024.pdf",
                        type: "application/pdf",
                        size: "4.1MB"
                    }
                ]
            }
        ];

        const sampleQueries = [
            "What project updates were shared?",
            "Are there any invoices or payments due?",
            "What are the new HR policies?",
            "Show me emails about software licenses",
            "Which emails have attachments?",
            "What's the professional development budget?"
        ];

        function showTab(tabName) {
            // Hide all tab panes
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab pane
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to selected tab
            event.target.classList.add('active');
        }

        async function makeRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json();
                
                return {
                    status: response.status,
                    success: response.ok,
                    data: data
                };
            } catch (error) {
                return {
                    status: 0,
                    success: false,
                    error: error.message
                };
            }
        }

        function showResult(containerId, contentId, result, isSuccess = true) {
            const container = document.getElementById(containerId);
            const content = document.getElementById(contentId);
            
            container.style.display = 'block';
            content.textContent = JSON.stringify(result, null, 2);
            
            if (isSuccess) {
                container.style.borderLeftColor = '#28a745';
            } else {
                container.style.borderLeftColor = '#dc3545';
            }
        }

        function loadSampleData() {
            document.getElementById('emailData').value = JSON.stringify(sampleEmailsData, null, 2);
        }

        function clearEmailData() {
            document.getElementById('emailData').value = '';
            document.getElementById('ingestResult').style.display = 'none';
        }

        async function ingestEmails() {
            const emailData = document.getElementById('emailData').value;
            
            if (!emailData.trim()) {
                alert('Please enter email data or load sample data first.');
                return;
            }
            
            try {
                const emails = JSON.parse(emailData);
                
                const result = await makeRequest(`${API_BASE}/ingest`, {
                    method: 'POST',
                    body: JSON.stringify({ emails })
                });
                
                showResult('ingestResult', 'ingestContent', result.data, result.success);
                
                if (result.success) {
                    alert(`Successfully ingested ${result.data.data.totalProcessed} emails!`);
                } else {
                    alert(`Error: ${result.data.error || result.error}`);
                }
            } catch (error) {
                alert(`Invalid JSON data: ${error.message}`);
            }
        }

        function loadSampleQueries() {
            const randomQuery = sampleQueries[Math.floor(Math.random() * sampleQueries.length)];
            document.getElementById('queryText').value = randomQuery;
        }

        async function queryEmails() {
            const query = document.getElementById('queryText').value;
            const topK = parseInt(document.getElementById('topK').value);
            const temperature = parseFloat(document.getElementById('temperature').value);
            const senderFilter = document.getElementById('senderFilter').value;
            
            if (!query.trim()) {
                alert('Please enter a question.');
                return;
            }
            
            const requestBody = {
                query,
                topK,
                temperature
            };
            
            if (senderFilter) {
                requestBody.filters = { sender_email: senderFilter };
            }
            
            const result = await makeRequest(`${API_BASE}/query`, {
                method: 'POST',
                body: JSON.stringify(requestBody)
            });
            
            showResult('queryResult', 'queryContent', result.data, result.success);
            
            if (!result.success) {
                alert(`Error: ${result.data.error || result.error}`);
            }
        }

        function clearFilters() {
            document.getElementById('listSender').value = '';
            document.getElementById('listDomain').value = '';
            document.getElementById('listLimit').value = '20';
            document.getElementById('hasAttachments').value = '';
            document.getElementById('listResult').style.display = 'none';
        }

        async function listEmails() {
            const sender = document.getElementById('listSender').value;
            const domain = document.getElementById('listDomain').value;
            const limit = document.getElementById('listLimit').value;
            const attachments = document.getElementById('hasAttachments').value;
            
            const params = new URLSearchParams();
            if (sender) params.append('sender_email', sender);
            if (domain) params.append('sender_domain', domain);
            if (limit) params.append('limit', limit);
            if (attachments) params.append('has_attachments', attachments);
            
            const result = await makeRequest(`${API_BASE}/list?${params}`);
            
            if (result.success) {
                displayEmailList('listContent', result.data.data.emails);
                document.getElementById('listResult').style.display = 'block';
            } else {
                showResult('listResult', 'listContent', result.data, false);
                alert(`Error: ${result.data.error || result.error}`);
            }
        }

        function displayEmailList(containerId, emails) {
            const container = document.getElementById(containerId);
            
            if (emails.length === 0) {
                container.innerHTML = '<div class="loading">No emails found.</div>';
                return;
            }
            
            container.innerHTML = emails.map(email => `
                <div class="email-item">
                    <div class="email-subject">${email.subject || 'No Subject'}</div>
                    <div class="email-meta">
                        <strong>From:</strong> ${email.sender_email} | 
                        <strong>To:</strong> ${email.receiver_emails.join(', ')} | 
                        <strong>Date:</strong> ${new Date(email.time_received).toLocaleString()} |
                        <strong>Attachments:</strong> ${email.attachment_count}
                    </div>
                </div>
            `).join('');
        }

        async function getStats() {
            const result = await makeRequest(`${API_BASE}/stats`);
            
            if (result.success) {
                const stats = result.data.data;
                document.getElementById('totalEmails').textContent = stats.totalEmails || 0;
                document.getElementById('uniqueSenders').textContent = stats.uniqueSenders || 0;
                document.getElementById('uniqueDomains').textContent = stats.uniqueDomains || 0;
                document.getElementById('totalAttachments').textContent = stats.totalAttachments || 0;
                document.getElementById('statsResult').style.display = 'block';
            } else {
                alert(`Error: ${result.data.error || result.error}`);
            }
        }

        async function checkHealth() {
            const result = await makeRequest(`${API_BASE}/health`);
            showResult('healthResult', 'healthContent', result.data, result.success);
            
            if (!result.success) {
                alert(`Error: ${result.data.error || result.error}`);
            }
        }

        function clearSearchForm() {
            document.getElementById('searchQuery').value = '';
            document.getElementById('searchSender').value = '';
            document.getElementById('searchDomain').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('subjectContains').value = '';
            document.getElementById('searchAttachments').value = '';
            document.getElementById('searchResult').style.display = 'none';
        }

        async function advancedSearch() {
            const query = document.getElementById('searchQuery').value;
            
            if (!query.trim()) {
                alert('Please enter a search query.');
                return;
            }
            
            const searchParams = {
                query,
                topK: 10
            };
            
            const sender = document.getElementById('searchSender').value;
            const domain = document.getElementById('searchDomain').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const subject = document.getElementById('subjectContains').value;
            const attachments = document.getElementById('searchAttachments').value;
            
            if (sender) searchParams.sender_email = sender;
            if (domain) searchParams.sender_domain = domain;
            if (dateFrom) searchParams.date_from = new Date(dateFrom).toISOString();
            if (dateTo) searchParams.date_to = new Date(dateTo).toISOString();
            if (subject) searchParams.subject_contains = subject;
            if (attachments) searchParams.has_attachments = attachments === 'true';
            
            const result = await makeRequest(`${API_BASE}/search`, {
                method: 'POST',
                body: JSON.stringify(searchParams)
            });
            
            if (result.success) {
                displaySearchResults('searchContent', result.data.data.results);
                document.getElementById('searchResult').style.display = 'block';
            } else {
                showResult('searchResult', 'searchContent', result.data, false);
                alert(`Error: ${result.data.error || result.error}`);
            }
        }

        function displaySearchResults(containerId, results) {
            const container = document.getElementById(containerId);
            
            if (results.length === 0) {
                container.innerHTML = '<div class="loading">No search results found.</div>';
                return;
            }
            
            container.innerHTML = results.map(result => `
                <div class="email-item">
                    <div class="email-subject">${result.subject || 'No Subject'} (Similarity: ${(result.similarity * 100).toFixed(1)}%)</div>
                    <div class="email-meta">
                        <strong>From:</strong> ${result.sender_email} | 
                        <strong>Date:</strong> ${new Date(result.time_received).toLocaleString()} |
                        <strong>Attachments:</strong> ${result.attachment_count}
                    </div>
                    <div style="margin-top: 10px; font-size: 14px; color: #6c757d;">
                        ${result.text_preview}
                    </div>
                </div>
            `).join('');
        }

        async function deleteEmail() {
            const emailId = document.getElementById('deleteEmailId').value;
            
            if (!emailId.trim()) {
                alert('Please enter an email ID.');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete email "${emailId}"?`)) {
                return;
            }
            
            const result = await makeRequest(`${API_BASE}/${emailId}`, {
                method: 'DELETE'
            });
            
            showResult('manageResult', 'manageContent', result.data, result.success);
            
            if (result.success) {
                alert('Email deleted successfully!');
                document.getElementById('deleteEmailId').value = '';
            } else {
                alert(`Error: ${result.data.error || result.error}`);
            }
        }

        async function batchDeleteEmails() {
            const sender = document.getElementById('batchDeleteSender').value;
            const domain = document.getElementById('batchDeleteDomain').value;
            
            if (!sender && !domain) {
                alert('Please specify either a sender email or domain for batch deletion.');
                return;
            }
            
            const filters = {};
            if (sender) filters.sender_email = sender;
            if (domain) filters.sender_domain = domain;
            
            const filterText = Object.entries(filters).map(([key, value]) => `${key}: ${value}`).join(', ');
            
            if (!confirm(`Are you sure you want to delete all emails matching: ${filterText}?`)) {
                return;
            }
            
            const result = await makeRequest(`${API_BASE}/delete-batch`, {
                method: 'POST',
                body: JSON.stringify({ filters })
            });
            
            showResult('manageResult', 'manageContent', result.data, result.success);
            
            if (result.success) {
                alert(`Deleted ${result.data.data.deletedCount} emails successfully!`);
                document.getElementById('batchDeleteSender').value = '';
                document.getElementById('batchDeleteDomain').value = '';
            } else {
                alert(`Error: ${result.data.error || result.error}`);
            }
        }

        async function clearAllEmails() {
            const confirmation = document.getElementById('confirmClear').value;
            
            if (confirmation !== 'DELETE_ALL_EMAILS') {
                alert('Please type "DELETE_ALL_EMAILS" to confirm deletion of all emails.');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è This will permanently delete ALL emails! Are you absolutely sure?')) {
                return;
            }
            
            const result = await makeRequest(`${API_BASE}/clear`, {
                method: 'POST',
                body: JSON.stringify({ confirm: 'DELETE_ALL_EMAILS' })
            });
            
            showResult('manageResult', 'manageContent', result.data, result.success);
            
            if (result.success) {
                alert('All emails cleared successfully!');
                document.getElementById('confirmClear').value = '';
            } else {
                alert(`Error: ${result.data.error || result.error}`);
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Email RAG Test Interface loaded successfully!');
        });
    </script>
</body>
</html>
